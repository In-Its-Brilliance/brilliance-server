# Server
```
cargo run
cargo test -- --nocapture
```

## ChunkMap -> `ChunksLoadState`

Хранит данные, о том какие чанки видны в данный момент игрокам.

- является единственным источником истины о том,
  какие чанки игрок ДОЛЖЕН видеть сейчас
- формирует только геометрический интерес (new / abandoned)
- не знает и не учитывает сетевое состояние


## Отправка чанков клиенту `send_chunks`

Работает ТОЛЬКО поверх `ChunksLoadState`

Отправляет чанк, если:
- он есть в `ChunksLoadState` (игрок должен его видеть)
- и его нет ни в send_chunk_queue, ни в confirmed_chunks

### 1) Update тик сервера
- служба `send_chunks` вызывается каждый тик
- она сама решает, есть ли что отправлять

### 2) Внутри `send_chunks`
- смотрит мир и список видимых чанков игрока
- если чанк не в `send_chunk_queue` и не в `confirmed_chunks`
- вызывается `ClientNetwork::send_chunk`
- чанк добавляется в `send_chunk_queue`
- чанк отправляется клиенту по сети

### 3) Асинхронно по сети
- клиент получил чанк
- клиент отправляет серверу сообщение `ChunkRecieved` что этот чанк получен и загружен

### 4) Network система сервера получает это сообщение
- вызывается `ClientNetwork::mark_chunks_as_recieved`
- чанк убирается из `send_chunk_queue` и добавляется в `confirmed_chunks`


## Сонхронизации перемещения `on_player_move`

### 1) По сети сообщение о перемещении игрока попадает в `on_player_move`
- Происходит вызов `WorldManager::player_move`
- Генерируется `ChunkMap::update_chunks_render` - `ChunkChanged`, где определяется из какого чанка куда передвинулся игрок
- `ChunkChanged` передаётся в `sync_player_move`

### 2) Выгрузка старых чанков
- Вызывается `ClientNetwork::send_chunks_to_unload` для удаления чанков, ушедшах из поля зрения
- Игроку отправляется сообщение `ServerMessages::UnloadChunks`

## Инварианты и переходы состояний чанка

### 1) Чанк может находиться только в одном состоянии:
- нужен игроку, но не отправлен (находится в ChunksLoadState)
- отправлен и ждёт подтверждения (send_chunk_queue)
- подтверждён клиентом (confirmed_chunks)
- больше не нужен игроку (покидает ChunksLoadState)

### 2) Переходы состояний:
- ChunksLoadState добавил чанк
  - send_chunks может его отправить
- send_chunks отправил чанк
  - чанк попадает в send_chunk_queue
- клиент подтвердил получение
  - чанк переносится в confirmed_chunks
- ChunkChanged сообщил, что чанк больше не нужен
  - чанк удаляется только из confirmed_chunks
  - send_chunk_queue не трогается

### Инвариант:
- один и тот же чанк никогда не может быть
  одновременно в send_chunk_queue и confirmed_chunks

### Чанки, ушедшие из видимости до подтверждения:

- Если чанк покинул ChunksLoadState,
  но всё ещё находится в send_chunk_queue,
  он считается "устаревшим в полёте"

Правило:
- такой чанк НЕ переносится в confirmed_chunks
- подтверждение от клиента для него игнорируется
- повторная отправка возможна только если
  чанк снова появится в ChunksLoadState
